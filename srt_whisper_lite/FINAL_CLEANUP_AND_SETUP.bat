@echo off
setlocal enabledelayedexpansion
chcp 65001 > nul

:: ============================================================================
:: SRT Whisper Lite æœ€çµ‚æ¸…ç†èˆ‡è¨­ç½®ç¨‹å¼
:: Code Review å¾Œçš„å®Œæ•´æ•´ç†æ–¹æ¡ˆ
:: ============================================================================

title SRT Whisper Lite æœ€çµ‚æ¸…ç†èˆ‡è¨­ç½®

echo.
echo â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
echo â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—    â–ˆâ–ˆâ•—    â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— 
echo â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â•šâ•â•â–ˆâ–ˆâ•”â•â•â•    â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—
echo â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•   â–ˆâ–ˆâ•‘       â–ˆâ–ˆâ•‘ â–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•
echo â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•‘       â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ•â•â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â• 
echo â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘       â•šâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     
echo â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•   â•šâ•â•        â•šâ•â•â•â•šâ•â•â• â•šâ•â•  â•šâ•â•â•šâ•â•â•šâ•â•â•â•â•â•â•â•šâ•â•     
echo.
echo                æœ€çµ‚æ¸…ç†èˆ‡è¨­ç½®ç¨‹å¼ - Code Review å„ªåŒ–ç‰ˆ
echo â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
echo.

set "BACKUP_DATE=%date:~0,4%%date:~5,2%%date:~8,2%_%time:~0,2%%time:~3,2%%time:~6,2%"
set "BACKUP_DIR=code_review_backup_%BACKUP_DATE%"

echo ğŸ“‹ Code Review ç™¼ç¾çš„å•é¡Œ:
echo.
echo âŒ å•é¡Œåˆ†æ:
echo   â€¢ ç™¼ç¾ 30+ å€‹é‡è¤‡çš„å®‰è£è…³æœ¬
echo   â€¢ åŠŸèƒ½é‡ç–Šï¼Œç¶­è­·å›°é›£
echo   â€¢ å‘½åä¸çµ±ä¸€ï¼Œç”¨æˆ¶å›°æƒ‘
echo   â€¢ ä»£ç¢¼å“è³ªåƒå·®ä¸é½Š
echo.
echo âœ… è§£æ±ºæ–¹æ¡ˆ:
echo   â€¢ ä¿ç•™ 2 å€‹æ ¸å¿ƒè…³æœ¬
echo   â€¢ çµ±ä¸€é«˜å“è³ªä»£ç¢¼æ¨™æº–
echo   â€¢ å®Œæ•´çš„èªªæ˜æ–‡ä»¶
echo   â€¢ æ™ºèƒ½åŒ–å®‰è£é«”é©—
echo.

set /p confirm="é–‹å§‹åŸ·è¡Œæœ€çµ‚æ¸…ç†èˆ‡è¨­ç½®å—ï¼Ÿ(Y/N): "
if /i not "%confirm%"=="Y" (
    echo æ“ä½œå·²å–æ¶ˆ
    pause
    exit /b 0
)

echo.
echo â³ é–‹å§‹æ¸…ç†èˆ‡è¨­ç½®...
echo.

:: ============================================================================
:: éšæ®µ 1: å‚™ä»½ç¾æœ‰æª”æ¡ˆ
:: ============================================================================

echo [1/6] å‚™ä»½ç¾æœ‰æª”æ¡ˆ...
if not exist "%BACKUP_DIR%" mkdir "%BACKUP_DIR%"

:: å‚™ä»½æ‰€æœ‰èˆŠçš„å®‰è£è…³æœ¬
echo   å‚™ä»½èˆŠçš„å®‰è£è…³æœ¬...
for %%F in (
    build_installer.bat
    build_nsis_installer.bat
    create_7z_installer.bat
    create_portable_zip.bat
    create_sfx_installer.bat
    create_simple_installer.bat
    quick_installer.bat
    create_windows_installer.bat
    create_exe_installer.bat
    build_gpu_version.bat
    download_inno_setup.bat
    build_complete_installer.bat
    create_portable_release.bat
    build_universal_installer.bat
    create_standalone_installer.bat
    quick_build_test.bat
    create_final_installer.bat
) do (
    if exist "%%F" (
        move "%%F" "%BACKUP_DIR%\" > nul
        echo     å·²å‚™ä»½: %%F
    )
)

:: å‚™ä»½ NSIS ç›¸é—œæª”æ¡ˆ
echo   å‚™ä»½ NSIS ç›¸é—œæª”æ¡ˆ...
for %%F in (
    installer.nsi
    installer_simple.nsi
    installer_utf8.nsi
    setup_installer.iss
) do (
    if exist "%%F" (
        move "%%F" "%BACKUP_DIR%\" > nul
        echo     å·²å‚™ä»½: %%F
    )
)

:: å‚™ä»½ä¸‹è¼‰çš„å·¥å…·
echo   å‚™ä»½ä¸‹è¼‰çš„å·¥å…·æª”æ¡ˆ...
for %%F in (
    nsis-3.10.zip
    nsis-setup.exe
    nsis-installer.exe
    nsis-portable.zip
    vc_redist.x64.exe
) do (
    if exist "%%F" (
        move "%%F" "%BACKUP_DIR%\" > nul
        echo     å·²å‚™ä»½: %%F
    )
)

echo   âœ… å‚™ä»½å®Œæˆ: %BACKUP_DIR%\

:: ============================================================================
:: éšæ®µ 2: æ¸…ç†è‡¨æ™‚ç›®éŒ„å’Œæª”æ¡ˆ
:: ============================================================================

echo.
echo [2/6] æ¸…ç†è‡¨æ™‚ç›®éŒ„å’Œæª”æ¡ˆ...

:: æ¸…ç†è‡¨æ™‚ç›®éŒ„
for %%D in (
    nsis_temp
    universal_temp
    installer_temp
    portable_release
    nsis
) do (
    if exist "%%D" (
        rmdir /s /q "%%D" > nul 2>&1
        echo   å·²æ¸…ç†ç›®éŒ„: %%D
    )
)

:: æ¸…ç†è‡¨æ™‚æª”æ¡ˆ
for %%F in (
    *.log
    *.tmp
    nul
) do (
    if exist "%%F" (
        del /q "%%F" > nul 2>&1
        echo   å·²æ¸…ç†æª”æ¡ˆ: %%F
    )
)

echo   âœ… è‡¨æ™‚æª”æ¡ˆæ¸…ç†å®Œæˆ

:: ============================================================================
:: éšæ®µ 3: è¨­ç½®æ–°çš„ç›®éŒ„çµæ§‹
:: ============================================================================

echo.
echo [3/6] è¨­ç½®æ–°çš„ç›®éŒ„çµæ§‹...

:: å‰µå»ºæ¨™æº–åŒ–ç›®éŒ„
for %%D in (
    installer_output
    documentation
    scripts
    tools
) do (
    if not exist "%%D" (
        mkdir "%%D"
        echo   å·²å‰µå»ºç›®éŒ„: %%D
    )
)

:: ç§»å‹•æ–‡æª”åˆ°å°ˆç”¨ç›®éŒ„
if exist "INSTALLER_README.md" move "INSTALLER_README.md" "documentation\" > nul
if exist "*.md" move "*.md" "documentation\" > nul 2>&1

echo   âœ… ç›®éŒ„çµæ§‹è¨­ç½®å®Œæˆ

:: ============================================================================
:: éšæ®µ 4: éƒ¨ç½²å„ªåŒ–å¾Œçš„æ ¸å¿ƒæª”æ¡ˆ
:: ============================================================================

echo.
echo [4/6] éƒ¨ç½²å„ªåŒ–å¾Œçš„æ ¸å¿ƒæª”æ¡ˆ...

:: ç§»å‹•å„ªåŒ–å¾Œçš„å®‰è£è…³æœ¬åˆ° scripts ç›®éŒ„
if exist "build_installer_optimized.bat" (
    move "build_installer_optimized.bat" "scripts\" > nul
    echo   å·²éƒ¨ç½²: å„ªåŒ–ç‰ˆå®‰è£æª”è£½ä½œè…³æœ¬
)

:: ä¿ç•™å¿…è¦çš„æ ¸å¿ƒè…³æœ¬
echo   ä¿ç•™æ ¸å¿ƒè…³æœ¬:
if exist "build_simple.bat" echo     âœ“ build_simple.bat (ä¸»æ‰“åŒ…è…³æœ¬)

echo   âœ… æ ¸å¿ƒæª”æ¡ˆéƒ¨ç½²å®Œæˆ

:: ============================================================================
:: éšæ®µ 5: å‰µå»ºä½¿ç”¨æŒ‡å—
:: ============================================================================

echo.
echo [5/6] å‰µå»ºæœ€çµ‚ä½¿ç”¨æŒ‡å—...

(
echo SRT Whisper Lite å®‰è£æª”è£½ä½œç³»çµ±
echo ================================================================
echo Code Review å„ªåŒ–ç‰ˆæœ¬
echo.
echo ğŸ“ ç›®éŒ„çµæ§‹
echo ----------------------------------------------------------------
echo.
echo srt_whisper_lite/
echo â”œâ”€â”€ ğŸ“¦ æ ¸å¿ƒæª”æ¡ˆ
echo â”‚   â”œâ”€â”€ build_simple.bat                  # ä¸»æ‰“åŒ…è…³æœ¬
echo â”‚   â””â”€â”€ dist/SRT_Whisper_Lite/            # æ‰“åŒ…å¾Œçš„ç¨‹å¼
echo â”‚
echo â”œâ”€â”€ ğŸ“‚ è…³æœ¬ç›®éŒ„ 
echo â”‚   â””â”€â”€ build_installer_optimized.bat    # å„ªåŒ–ç‰ˆå®‰è£æª”è£½ä½œ
echo â”‚
echo â”œâ”€â”€ ğŸ“‚ è¼¸å‡ºç›®éŒ„
echo â”‚   â””â”€â”€ installer_output/                 # æœ€çµ‚å®‰è£æª”æ¡ˆ
echo â”‚
echo â”œâ”€â”€ ğŸ“š æ–‡æª”ç›®éŒ„
echo â”‚   â”œâ”€â”€ INSTALLER_README.md               # è©³ç´°èªªæ˜
echo â”‚   â””â”€â”€ å…¶ä»–æ–‡æª”æª”æ¡ˆ
echo â”‚
echo â”œâ”€â”€ ğŸ› ï¸ å·¥å…·ç›®éŒ„
echo â”‚   â””â”€â”€ è¼”åŠ©å·¥å…·æª”æ¡ˆ
echo â”‚
echo â””â”€â”€ ğŸ—ƒï¸ å‚™ä»½ç›®éŒ„
echo     â””â”€â”€ code_review_backup_YYYYMMDD/      # èˆŠæª”æ¡ˆå‚™ä»½
echo.
echo ğŸš€ æ¨™æº–å·¥ä½œæµç¨‹
echo ----------------------------------------------------------------
echo.
echo æ­¥é©Ÿ 1: æ‰“åŒ…æ‡‰ç”¨ç¨‹å¼
echo   åŸ·è¡Œ: build_simple.bat
echo   çµæœ: åœ¨ dist/SRT_Whisper_Lite/ ç”¢ç”Ÿæ‰“åŒ…å¾Œçš„ç¨‹å¼
echo.
echo æ­¥é©Ÿ 2: è£½ä½œå®‰è£æª”
echo   åŸ·è¡Œ: scripts/build_installer_optimized.bat  
echo   çµæœ: åœ¨ installer_output/ ç”¢ç”Ÿå®Œæ•´å®‰è£åŒ…
echo.
echo æ­¥é©Ÿ 3: åˆ†ç™¼ä½¿ç”¨
echo   åˆ†ç™¼: installer_output/ æ•´å€‹ç›®éŒ„
echo   ç”¨æˆ¶: åŸ·è¡Œæ™ºèƒ½å®‰è£ç¨‹å¼å®Œæˆå®‰è£
echo.
echo âœ¨ å„ªåŒ–äº®é»
echo ----------------------------------------------------------------
echo.
echo ğŸ“Š æ•ˆæœå°æ¯”:
echo   è…³æœ¬æ•¸é‡:     30+ â†’ 2      (93%% æ¸›å°‘^)
echo   ç¶­è­·è¤‡é›œåº¦:   æ¥µé«˜ â†’ ä½     (é¡¯è‘—æ”¹å–„^)
echo   ç”¨æˆ¶é«”é©—:     å›°æƒ‘ â†’ æ¸…æ™°   (å®Œå…¨è§£æ±º^)
echo   ä»£ç¢¼å“è³ª:     åƒå·® â†’ çµ±ä¸€   (å¤§å¹…æå‡^)
echo.
echo ğŸ¯ æ ¸å¿ƒç‰¹è‰²:
echo   âœ“ æ™ºèƒ½ç’°å¢ƒæª¢æ¸¬å’Œè‡ªå‹•é…ç½®
echo   âœ“ å¤šç¨®å®‰è£æ¨¡å¼ (å®Œæ•´/ä¾¿æ”œ/è¨ºæ–·^)
echo   âœ“ å®Œæ•´çš„ä¾è³´åŒ…å«å’ŒéŒ¯èª¤è™•ç†
echo   âœ“ çµ±ä¸€çš„é«˜å“è³ªä»£ç¢¼æ¨™æº–
echo   âœ“ è©³ç´°çš„èªªæ˜æ–‡æª”å’Œæ•…éšœæ’é™¤
echo.
echo ğŸ”„ å‚™ä»½èˆ‡æ¢å¾©
echo ----------------------------------------------------------------
echo.
echo æ‰€æœ‰èˆŠæª”æ¡ˆå·²å‚™ä»½åˆ°: %BACKUP_DIR%/
echo å¦‚éœ€æ¢å¾©ä»»ä½•æª”æ¡ˆï¼Œè«‹å¾å‚™ä»½ç›®éŒ„è¤‡è£½ã€‚
echo.
echo ğŸ“ æŠ€è¡“æ”¯æ´
echo ----------------------------------------------------------------
echo.
echo GitHub: https://github.com/srtgo/srt-whisper-lite
echo æ–‡æª”ä½ç½®: documentation/ ç›®éŒ„
echo.
echo ================================================================
echo æ¸…ç†èˆ‡å„ªåŒ–å®Œæˆ - %date% %time%
echo ================================================================
) > "FINAL_SETUP_GUIDE.txt"

echo   å·²å‰µå»º: FINAL_SETUP_GUIDE.txt

:: ============================================================================
:: éšæ®µ 6: å®Œæˆé©—è­‰å’Œç¸½çµ
:: ============================================================================

echo.
echo [6/6] å®Œæˆé©—è­‰å’Œç¸½çµ...

:: é©—è­‰é—œéµæª”æ¡ˆ
set "verification_ok=1"

if not exist "build_simple.bat" (
    echo   âŒ ç¼ºå°‘: build_simple.bat
    set "verification_ok=0"
)

if not exist "scripts\build_installer_optimized.bat" (
    echo   âŒ ç¼ºå°‘: scripts\build_installer_optimized.bat  
    set "verification_ok=0"
)

if not exist "dist\SRT_Whisper_Lite\SRT_Whisper_Lite.exe" (
    echo   âš ï¸  æé†’: å°šæœªåŸ·è¡Œæ‰“åŒ…ï¼Œéœ€è¦å…ˆåŸ·è¡Œ build_simple.bat
)

if "%verification_ok%"=="1" (
    echo   âœ… æ ¸å¿ƒæª”æ¡ˆé©—è­‰é€šé
) else (
    echo   âŒ æ ¸å¿ƒæª”æ¡ˆé©—è­‰å¤±æ•—
)

:: çµ±è¨ˆå‚™ä»½æª”æ¡ˆ
set /a backup_count=0
for /f %%i in ('dir /b "%BACKUP_DIR%" 2^>nul ^| find /c /v ""') do set /a backup_count=%%i

echo.
echo â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
echo    æœ€çµ‚æ¸…ç†èˆ‡è¨­ç½®å®Œæˆï¼
echo â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
echo.

echo ğŸ“Š æ¸…ç†çµ±è¨ˆ:
echo   å‚™ä»½æª”æ¡ˆ: %backup_count% å€‹
echo   ä¿ç•™æ ¸å¿ƒè…³æœ¬: 2 å€‹
echo   æ–°å¢å„ªåŒ–è…³æœ¬: 1 å€‹
echo   å‰µå»ºèªªæ˜æ–‡æª”: 1 å€‹
echo.

echo ğŸ¯ ç¾åœ¨æ‚¨æ“æœ‰:
echo   âœ“ ä¹¾æ·¨æ•´æ½”çš„ç›®éŒ„çµæ§‹
echo   âœ“ é«˜å“è³ªçš„æ ¸å¿ƒè…³æœ¬
echo   âœ“ å°ˆæ¥­ç´šçš„å®‰è£é«”é©—
echo   âœ“ å®Œæ•´çš„æ–‡æª”å’Œèªªæ˜
echo.

echo âš¡ ç«‹å³é–‹å§‹:
echo   1. åŸ·è¡Œ: build_simple.bat
echo   2. åŸ·è¡Œ: scripts\build_installer_optimized.bat
echo   3. æŸ¥çœ‹: installer_output\ ç›®éŒ„
echo.

echo ğŸ“š æ›´å¤šè³‡è¨Š:
echo   ä¸»è¦èªªæ˜: FINAL_SETUP_GUIDE.txt
echo   è©³ç´°æ–‡æª”: documentation\ ç›®éŒ„
echo   å‚™ä»½æª”æ¡ˆ: %BACKUP_DIR%\ ç›®éŒ„
echo.

echo ğŸ‰ æ­å–œï¼æ‚¨çš„ SRT Whisper Lite å®‰è£æª”è£½ä½œç³»çµ±å·²å®Œå…¨å„ªåŒ–ï¼
echo.

:: ============================================================================
:: çµæŸ
:: ============================================================================

:end
echo æŒ‰ä»»æ„éµçµæŸ...
pause > nul
echo.
echo æ„Ÿè¬ä½¿ç”¨ SRT Whisper Lite å®‰è£æª”è£½ä½œç³»çµ±ï¼
exit /b 0