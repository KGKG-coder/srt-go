name: Release Builder

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release Version (e.g., v2.2.1)'
        required: true
        type: string
      release_type:
        description: 'Release Type'
        required: true
        default: 'stable'
        type: choice
        options:
        - stable
        - beta
        - alpha
      include_models:
        description: 'Bundle AI Models'
        required: true
        default: true
        type: boolean

jobs:
  create-release:
    name: "Create Release"
    runs-on: windows-latest
    timeout-minutes: 90
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: srt_whisper_lite/electron-react-app/package-lock.json

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install Dependencies
      run: |
        cd srt_whisper_lite/electron-react-app
        npm ci
        pip install -r python/requirements.txt
        cd ../../tests
        pip install -r requirements-ci.txt

    - name: Update Version Info
      run: |
        cd srt_whisper_lite/electron-react-app
        npm version ${{ github.event.inputs.version }} --no-git-tag-version

    - name: Pre-build Validation using unified runner
      run: |
        cd tests
        echo "Running pre-build validation tests..."
        python run_all_tests.py --categories "Unit Tests" --quick-mode --pre-build-check

    - name: Build Application (with models)
      if: ${{ github.event.inputs.include_models == 'true' }}
      run: |
        cd srt_whisper_lite/electron-react-app
        npm run build:with-models
        npm run dist:nsis

    - name: Build Application (without models)
      if: ${{ github.event.inputs.include_models == 'false' }}
      run: |
        cd srt_whisper_lite/electron-react-app
        npm run react:build
        npm run dist:nsis

    - name: Create Portable Version
      run: |
        cd srt_whisper_lite/electron-react-app
        npm run dist:portable

    - name: Prepare Release Assets
      run: |
        mkdir release_assets
        $version = "${{ github.event.inputs.version }}"
        $type = "${{ github.event.inputs.release_type }}"
        
        # Copy installer
        if (Test-Path "srt_whisper_lite/electron-react-app/dist/*.exe") {
          $installer = Get-ChildItem "srt_whisper_lite/electron-react-app/dist/*.exe" | Select-Object -First 1
          if (${{ github.event.inputs.include_models }} -eq 'true') {
            Copy-Item $installer.FullName "release_assets/SRT-GO-Enhanced-$version-Complete.exe"
          } else {
            Copy-Item $installer.FullName "release_assets/SRT-GO-Enhanced-$version-Setup.exe"
          }
        }
        
        # Create portable ZIP
        if (Test-Path "srt_whisper_lite/electron-react-app/dist/win-unpacked") {
          Compress-Archive -Path "srt_whisper_lite/electron-react-app/dist/win-unpacked/*" -DestinationPath "release_assets/SRT-GO-Portable-$version.zip"
        }

    - name: Generate Release Notes
      run: |
        $version = "${{ github.event.inputs.version }}"
        $type = "${{ github.event.inputs.release_type }}"
        $models = "${{ github.event.inputs.include_models }}"
        
        @"
        # SRT GO Enhanced $version ($type)
        
        ## üì¶ Installation Options
        
        ### üéØ Complete Package (Recommended)
        - **SRT-GO-Enhanced-$version-Complete.exe** - Includes all AI models (offline ready)
        - File size: ~102MB
        - No internet required after installation
        
        ### üåê Standard Package  
        - **SRT-GO-Enhanced-$version-Setup.exe** - Downloads models on first run
        - File size: ~93MB  
        - Requires internet connection for initial setup
        
        ### üíæ Portable Version
        - **SRT-GO-Portable-$version.zip** - No installation required
        - Extract and run directly
        - Perfect for USB drives
        
        ## üöÄ Key Features
        - **FP16/INT8 Smart Fallback**: GPU auto-detection with intelligent model selection
        - **Enhanced Voice Detection v2.0**: 25D ML feature analysis
        - **Real-time Performance Monitoring**: RTF calculation with 5-tier classification
        - **Multi-language Support**: Auto-detect with Traditional Chinese conversion
        
        ## üìä Performance
        - **GPU Mode**: RTF < 0.3 (CUDA FP16)
        - **CPU Mode**: RTF < 0.8 (INT8 optimization)
        - **Accuracy**: 95-99% recognition rate
        
        ## üîß System Requirements
        - Windows 10/11 (x64)
        - 4GB RAM minimum (8GB recommended)
        - Optional: NVIDIA GPU with CUDA 11.8+
        
        ---
        *Built with GitHub Actions ‚Ä¢ Quality assured with 100% E2E test coverage*
        "@ | Out-File -FilePath "RELEASE_NOTES.md" -Encoding UTF8

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.event.inputs.version }}
        name: SRT GO Enhanced ${{ github.event.inputs.version }}
        body_path: RELEASE_NOTES.md
        files: release_assets/*
        draft: ${{ github.event.inputs.release_type != 'stable' }}
        prerelease: ${{ github.event.inputs.release_type != 'stable' }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload Build Logs
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: release-build-logs-${{ github.event.inputs.version }}
        path: |
          srt_whisper_lite/electron-react-app/dist/
          srt_whisper_lite/electron-react-app/logs/